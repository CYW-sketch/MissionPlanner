# 双监听功能启用说明

## 回答：双监听功能**不是**一直启用的

### 一、启用条件

双监听功能的启用需要**同时满足两个条件**：

#### 条件1：`EnableDualListen = true`
- **默认值**：`false`（第5432行定义）
- **设置为true的时机**：
  1. 加载自动连接配置时（第1481行）
  2. 用户配置自动连接并保存时（第1795行）

#### 条件2：`_manualConnectedOnce = true`
- 必须已经手动连接过一次
- 在 `MarkManualConnect()` 方法中设置为true（第5840行）

### 二、代码证据

```csharp
// 第5538-5539行：SetupPassiveListener() 中的检查
if (!EnableDualListen || !_manualConnectedOnce)
    return;  // 如果不满足条件，直接返回，不启动被动监听
```

### 三、启用时机分析

#### 1. 初始状态
```
启动程序 → EnableDualListen = false（默认）
                  ↓
          不启用双监听功能
```

#### 2. 加载配置后
```
LoadAutoConnectConfig() 
  → EnableDualListen = true
                  ↓
          双监听功能准备就绪
  （但还没有被动监听，因为尚未手动连接）
```

#### 3. 第一次手动连接后
```
用户点击连接UDP 
  → MarkManualConnect() 
  → _manualConnectedOnce = true
                  ↓
      此时两个条件都满足
                  ↓
  SetupPassiveListener() 启动被动监听
```

#### 4. 启动被动监听
```
SetupPassiveListener()
  ↓
  检查：EnableDualListen && _manualConnectedOnce
  ↓
  如果都为true，则启动被动监听端口
```

### 四、实际运行流程

#### 程序启动时
```
1. AutoConnectManager初始化
   - EnableDualListen = false（默认）
   - _manualConnectedOnce = false
   
2. 加载自动连接配置
   - EnableDualListen = true（设置为true）
   - 日志：DualListen: True
   
3. 双监听功能已准备，但被动监听尚未启动
```

#### 第一次UDP连接时
```
1. 用户选择UDP连接
   - 弹出端口选择对话框
   - 输入端口号（如14551）
   
2. MarkManualConnect()
   - _manualConnectedOnce = true（设置为true）
   
3. doConnect() 打开主动端口
   - comPort.Open() → 14551端口连接成功
   
4. Initialize() 启动质量监控
   - 订阅主动链路质量监控
   
5. 此时触发SetupPassiveListener()
   - 检查：EnableDualListen == true ✓
   - 检查：_manualConnectedOnce == true ✓
   - 两个条件都满足，启动被动监听
   
6. 启动被动端口（14552）
   - 在后台线程中异步启动
   - 静默连接，不显示UI
   - 启动被动质量监控
```

#### 后续运行时
```
✅ 双监听功能持续启用
   - EnableDualListen = true
   - _manualConnectedOnce = true
   - 每次UDP连接都会自动启动被动监听
```

### 五、如何确认是否启用

#### 查看日志
```
AutoConnect configured - ..., DualListen: {AutoConnectManager.EnableDualListen}, Enabled: {enabled}
```
如果看到 `DualListen: True` 则已启用双监听准备。

#### 查看连接质量报告
```
UDP Dual Port Quality - Active: UDP 14551 (0.95) | Passive: UDP 14552 (0.93)
```
如果看到这样的日志，说明双监听已启动。

```
UDP Single Port Quality - Active: UDP 14551 (0.95) | Passive: UDP 14552 (Not Connected)
```
如果看到这样的日志，说明双监听未启动（被动端口未连接）。

### 六、禁用双监听的方法

#### 方法1：修改代码
```csharp
// 第1481行和1795行
AutoConnectManager.EnableDualListen = false; // 禁用双端UDP监听功能
```

#### 方法2：运行时检查
如果需要动态禁用，可以添加条件判断：
```csharp
// 在SetupPassiveListener()中添加额外检查
if (!EnableDualListen || !_manualConnectedOnce || 一些其他条件)
    return;
```

### 七、总结

| 特性 | 状态 |
|------|------|
| 默认启用 | ❌ 否（默认false） |
| 加载配置后 | ✅ 准备启用（EnableDualListen = true） |
| 首次连接后 | ✅ 完全启用（被动监听启动） |
| 后续连接 | ✅ 持续启用 |
| 需要两个条件 | ✅ 是（EnableDualListen + _manualConnectedOnce） |

**结论**：双监听功能不是一直启用的，需要满足两个条件才会真正启动被动监听。

