# 自动连接功能使用说明

## 功能概述

此功能为Mission Planner添加了TCP自动连接功能，支持在两个TCP地址之间自动切换，当主连接断开时自动尝试备用连接。

## 主要特性

1. **双TCP地址支持**: 支持配置主TCP地址和备用TCP地址
2. **自动切换**: 当主连接断开时，自动切换到备用地址
3. **智能检测**: 通过数据包超时检测连接状态
4. **手动控制**: 支持手动断开连接，不会触发自动重连
5. **配置界面**: 提供简单的配置对话框

## 使用方法

### 1. 默认配置

系统会自动配置以下默认设置：
- **主TCP地址**: 本机IP地址（自动检测）
- **备用TCP地址**: 192.168.4.13
- **端口**: 5760
- **自动连接**: 默认启用

### 2. 手动配置TCP地址

如果需要修改配置，可以通过以下方式：

```csharp
// 在代码中配置
MainV2.AutoConnectManager.SetTcpAddresses("192.168.1.100", "192.168.1.101", "5760");
MainV2.AutoConnectManager.EnableAutoConnect();
```

### 2. 使用配置对话框

调用 `ConfigureAutoConnect()` 方法可以打开配置对话框，设置：
- 主TCP地址
- 备用TCP地址  
- 端口号
- 是否启用自动连接

### 3. 自动连接工作流程

1. **初始连接**: 用户手动连接到任意TCP地址（主地址或备用地址）
2. **地址检测**: 系统自动检测当前连接的TCP地址
3. **监控状态**: 系统每秒检查连接状态和数据包接收情况
4. **检测断开**: 当超过2秒没有收到有效数据包时，认为连接断开
5. **智能切换**: 自动尝试连接到另一个TCP地址
6. **持续监控**: 重连后继续监控，如果再次断开会切换回之前的地址
7. **循环切换**: 在两个地址之间持续切换，直到手动断开连接

### 4. 手动断开和重连

当用户手动断开连接时：
- 系统会标记为手动断开，不会触发自动重连
- 自动保存当前连接的TCP地址和端口

**连接操作：**
- **每次手动连接**: 弹出输入框让用户输入TCP地址（端口使用默认值5760）
- **用户输入控制**: 用户可以选择连接到任意TCP地址
- **自动连接**: 系统会在用户输入的地址和备用地址之间自动切换
- **修复重复弹窗**: 解决了之前会弹出两次地址输入框和两次端口输入框的问题
- **修复连接状态**: 解决了自动连接时显示连接失败但实际连接成功的问题
- **修复编译错误**: 解决了访问私有字段和私有方法导致的编译错误
- **修复连接状态更新**: 解决了左上角连接状态没有实时更新的问题
- **修复编译错误**: 解决了访问私有字段_connectionControl导致的编译错误

## 技术实现

### 核心类

- `AutoConnectManager`: 自动连接管理器
- 集成在 `MainV2` 类中

### 关键方法

- `Initialize()`: 初始化连接监控
- `SetTcpAddresses()`: 设置TCP地址配置
- `EnableAutoConnect()`: 启用自动连接
- `MarkManualDisconnect()`: 标记手动断开
- `CheckConnectionStatus()`: 检查连接状态

### 配置存储

配置信息保存在Settings中：
- `AutoConnect_PrimaryHost`: 主TCP地址
- `AutoConnect_BackupHost`: 备用TCP地址
- `AutoConnect_Port`: 端口号
- `AutoConnect_Enabled`: 是否启用

## 注意事项

1. **网络稳定性**: 确保两个TCP地址都可用
2. **端口配置**: 两个地址使用相同端口
3. **超时设置**: 默认5秒无数据包认为断开
4. **资源管理**: 系统会自动管理连接资源

## 故障排除

如果自动连接不工作，请检查：
1. TCP地址配置是否正确
2. 网络连接是否正常
3. 端口是否被占用
4. 防火墙设置

## 扩展功能

可以根据需要扩展以下功能：
- 添加更多备用地址
- 调整超时时间
- 添加连接质量评估
- 集成到现有菜单系统
