# 自动连接与双监听（质量切换）使用说明

## 功能概述

此功能为 Mission Planner 添加了 TCP/UDP 自动连接与“同时监听”能力：在连接主地址/端口的同时，被动连接到备用端（TCP 为备用地址端口；UDP 为另一监听端口），持续监控两侧链路质量；当活跃链路质量低于阈值且满足切换条件时，自动切换至另一端。

## 主要特性

1. **双端同时监听**:
   - TCP: 主动连接主地址端口，同时被动连接备用地址端口
   - UDP: 主动连接一个端口，同时被动监听另一个端口（默认端口对为 14451/14452）
2. **质量阈值切换**: 基于滑动窗口的链路质量（收到/丢失包比）自动切换，防止抖动（最小切换间隔）
3. **掉线重连**: 活跃链路掉线时自动尝试另一端
4. **手动控制**: 支持手动断开连接，不会触发自动重连
5. **配置界面**: 可配置主/备地址端口、质量阈值、窗口时长与最小切换间隔

## 使用方法

### 1. 默认配置

系统会自动配置以下默认设置：
- **主TCP地址**: 本机 IP（自动检测）
- **备用TCP地址**: 192.168.4.13
- **主端口/备端口**: 默认 5760（可分别配置）
- **自动连接**: 默认启用
- **双监听**: 默认启用（无需用户勾选）
- **质量阈值**: 默认 0.70（70%）
- **质量窗口**: 默认 3 秒（每秒滚动）
- **最小切换间隔**: 默认 10 秒
 - **UDP 双监听端口对**: 14451 / 14452（活跃在哪一端，被动监听自动选择另一端）

### 2. 手动配置 TCP 地址

如果需要修改配置，可以通过以下方式：

```csharp
// 在代码中配置（主/备地址与各自端口）
MainV2.AutoConnectManager.SetTcpAddresses(
    primaryHost: "192.168.1.100",
    primaryPort: "5760",
    backupHost:  "192.168.1.101",
    backupPort:  "5760");
MainV2.AutoConnectManager.SetQualityPolicy(threshold: 0.70, windowSec: 3, minSwitchIntervalSec: 10);
MainV2.AutoConnectManager.EnableAutoConnect();
```

### 3. 使用配置对话框

调用 `ConfigureAutoConnect()` 打开配置对话框，可设置：
- 主 TCP 地址
- 主端口（备用端口在内部使用，也可在设置存储中调整）
- 质量阈值（0–1）
- 质量窗口（秒）
- 最小切换间隔（秒）
- 是否启用自动连接

### 4. 自动连接与双监听工作流程

1. **初始连接**: 用户手动输入“目标地址+端口”并连接（端口可有默认值）
2. **质量订阅**: 对活跃链路订阅收到/丢失包，计算滑动窗口质量（与“链接统计”一致）
3. **被动监听**:
   - TCP: 同时以被动方式连接备用地址端口，预备切换
   - UDP: 同时以被动方式在另一 UDP 端口监听（14451/14452 互为对端）
4. **质量评估**: 若活跃质量 < 阈值且超过最小切换间隔，优先在备用质量更好时切换；否则按保守策略切换
5. **掉线重连**: 活跃链路掉线（>2 秒无有效包）时，自动尝试连接另一端
6. **循环监控**: 切换后继续双端监听，保证实时评估

### 5. 手动断开和重连

当用户手动断开连接时：
- 系统会标记为手动断开，不会触发自动重连
- 自动保存当前连接的TCP地址和端口

**连接操作：**
- **每次手动连接**: 只需输入目标地址与端口（端口可用默认值）；无需填写备用信息
- **自动连接**: 系统自动在主/备之间双监听与切换
- **修复重复弹窗**: 解决了之前会弹出两次地址输入框和两次端口输入框的问题
- **修复连接状态**: 解决了自动连接时显示连接失败但实际连接成功的问题
- **修复编译错误**: 解决了访问私有字段和私有方法导致的编译错误
- **修复连接状态更新**: 解决了左上角连接状态没有实时更新的问题
- **修复编译错误**: 解决了访问私有字段_connectionControl导致的编译错误

## 技术实现

### 核心类

- `AutoConnectManager`（集成在 `MainV2` 中）：
  - 主/备地址与端口管理
  - 同时监听（被动）建立与重建
  - 活跃链路质量计算与切换策略

### 关键方法（源码定位）

- `Initialize()`：初始化监控与订阅，并 `SetupPassiveListener()`
- `SetTcpAddresses()`：设置主/备地址与端口
- `SetQualityPolicy()`：设置质量阈值、窗口、最小切换间隔
- `SetupPassiveListener()`：建立备用端被动监听（`TcpSerial + MAVLinkInterface`）
- `EvaluateQualityAndMaybeSwitch()`：质量评估与切换
- `AttemptReconnect()` / `ConnectToTcp()`：执行切换与连接
- `CheckConnectionStatus()`：掉线监测与重连尝试

### 配置存储

配置信息保存在Settings中：
- `AutoConnect_PrimaryHost`: 主 TCP 地址
- `AutoConnect_BackupHost`: 备用 TCP 地址
- `AutoConnect_PrimaryPort`: 主端口
- `AutoConnect_BackupPort`: 备用端口
- `AutoConnect_QualityThreshold`: 质量阈值（0–1，默认 0.70）
- `AutoConnect_QualityWindowSec`: 质量窗口秒数（默认 3）
- `AutoConnect_MinSwitchIntervalSec`: 最小切换间隔秒数（默认 10）
- `AutoConnect_Enabled`: 是否启用自动连接

## 注意事项

1. **网络稳定性**: 确保两个 TCP 地址均可达
2. **端口配置**: 主/备端口可相同或不同；UDP 模式下默认使用 14451/14452 作为端口对，无需额外配置
3. **质量指标**: 质量与“链接统计”一致（收到/丢失包的比例，窗口平均）
4. **掉线判定**: 默认 >2 秒无有效包视为掉线
5. **资源管理**: 被动监听为轻量连接，不取参数、不弹 UI

## 故障排除

如果自动连接不工作，请检查：
1. TCP地址配置是否正确
2. 网络连接是否正常
3. 端口是否被占用
4. 防火墙设置

## 扩展功能

可以根据需要扩展以下功能：
- 添加更多备用地址并做优选
- 在 UI 中展示备用链路的实时质量
- 为不同链路设置不同阈值与窗口
- 更灵活的切换策略（例如滞回）
